name: Update State on Merge

on:
  pull_request:
    types: [closed]

concurrency:
  group: enjoy-game-state
  cancel-in-progress: false

jobs:
  update-state:
    if: github.event.pull_request.merged == true
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECURITY NOTE: PAT on ubuntu-latest is SAFE here because:
    # 1. This only runs AFTER PR is merged (pull_request: closed + merged == true)
    # 2. We checkout 'main' branch, NOT the PR branch
    # 3. The workflow YAML comes from main, not from the PR
    # 4. The PAT is needed to: a) push commits b) trigger downstream workflows
    # DO NOT change this to checkout the PR branch or run PR code!
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.PAT }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Configure git
        run: |
          git config user.name "enjoy-bot"
          git config user.email "bot@enjoy.game"
      
      - name: Update state
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_CREATED: ${{ github.event.pull_request.created_at }}
          PR_MERGED: ${{ github.event.pull_request.merged_at }}
        run: |
          # Parse PR title for word extraction (e.g. "Add word: HELLO")
          PR_WORD=$(echo "$PR_TITLE" | grep -oEi 'add\s+word[:\s]+[a-zA-Z]+' | awk '{print $NF}' || echo "")
          echo "Extracted word: $PR_WORD"
          
          # Run the game engine (compiled)
          # We use the 'apply' command which now uses the Executor
          node engine/dist/index.js apply \
            --pr-number="$PR_NUMBER" \
        env:
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_WORD: ${{ env.PR_WORD }} # Need to set this in previous step output or simply pass it in the command or export it

      
      - name: Commit and push
        run: |
          git add state.json
          if git diff --staged --quiet; then
            echo "::notice::No changes to commit"
          else
            git commit -m "ğŸ“Š State update from PR #${{ github.event.pull_request.number }} [skip ci]"
            if ! git push; then
              echo "::warning::Push failed - may require manual sync or retry"
              exit 1
            fi
          fi
